name: SSH2Actions

on:
  workflow_dispatch:
    inputs:
      SSH:
        description: "SSH 连接到 Actions"
        required: false
        default: "true"
      python_version:
        description: "Python版本"
        required: true
        default: "3.13"
      retention_days:
        description: "Artifact保留天数"
        required: true
        default: "3"
      outputs_folder:
        description: "要打包的文件夹名称"
        required: true
        default: "testcache"

jobs:
  build:
    runs-on: ubuntu-latest
    name: Setup Python ${{ github.event.inputs.python_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true  # 允许后续步骤推送代码

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}

      - name: Initialization
        run: |
          echo ${{ github.event.inputs.python_version }}
          # chmod +x init*.sh
          # source initpy.sh

      - name: Start tmate session (SSH debug)
        uses: mxschmitt/action-tmate@v3
        if: (github.event.inputs.SSH == 'true' && github.event.inputs.SSH  != 'false') || contains(github.event.action, 'SSH')

      - name: Check outputs folder
        id: check_outputs
        run: |
          FOLDER="${{ github.event.inputs.outputs_folder }}"
          if [ -d "$FOLDER" ] && [ "$(ls -A $FOLDER)" ]; then
            echo "folder_not_empty=true" >> $GITHUB_OUTPUT
            echo "$FOLDER 文件夹不为空，将执行打包上传"
          else
            echo "folder_not_empty=false" >> $GITHUB_OUTPUT
            echo "$FOLDER 文件夹为空，跳过打包上传"
          fi

      - name: Zip outputs folder
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        run: |
          FOLDER="${{ github.event.inputs.outputs_folder }}"
          zip -r ${FOLDER}.zip ${FOLDER}/

      - name: Upload to GitHub Artifacts
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.outputs_folder }}
          path: ${{ github.event.inputs.outputs_folder }}.zip
          retention-days: ${{ github.event.inputs.retention_days }}

      - name: Commit and push changes
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        run: |
          FOLDER="${{ github.event.inputs.outputs_folder }}"
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add ${FOLDER}/
          git diff --staged --quiet || git commit -m "Update ${FOLDER} folder - $(date)"
          git push
