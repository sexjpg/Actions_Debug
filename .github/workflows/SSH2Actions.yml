name: SSH2Actions

on:
  workflow_dispatch:
    inputs:
      SSH:
        description: "SSH 连接到 Actions"
        required: false
        default: "true"
      python_version:
        description: "Python版本"
        required: true
        default: "3.13"
      timeout_min:
        description: "SSH超时时间(分钟)"
        required: true
        default: "30"
      retention_days:
        description: "Artifact保留天数"
        required: true
        default: "30"
      outputs_dir:
        description: "Outputs 文件夹路径"
        required: true
        default: "outputs"

jobs:
  build:
    runs-on: ubuntu-latest
    name: Setup Python ${{ github.event.inputs.python_version }}
    env:
      OUTPUTS_DIR: ${{ github.event.inputs.outputs_dir }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - uses: actions/setup-python@v3
        with:
          python-version: ${{ github.event.inputs.python_version }}

      - name: Initialization
        run: |
          echo ${{ github.event.inputs.python_version }}
          # chmod +x init*.sh
          # source initpy.sh

      - name: Start tmate session (SSH debug)
        uses: mxschmitt/action-tmate@v3
        if: (github.event.inputs.SSH == 'true' && github.event.inputs.SSH  != 'false') || contains(github.event.action, 'SSH')
        with:
          tmate-server-host: ssh.tmate.io # 替换为其他 tmate 服务器
          # timeout-min: ${{ github.event.inputs.timeout_min }}

      - name: Check outputs folder
        id: check_outputs
        run: |
          if [ -d "$OUTPUTS_DIR" ] && [ "$(ls -A \"$OUTPUTS_DIR\")" ]; then
            echo "folder_not_empty=true" >> $GITHUB_OUTPUT
            echo "$OUTPUTS_DIR 文件夹不为空，将执行打包上传"
          else
            echo "folder_not_empty=false" >> $GITHUB_OUTPUT
            echo "$OUTPUTS_DIR 文件夹为空，跳过打包上传"
          fi

      - name: Zip outputs folder
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        run: |
          zip -r "${OUTPUTS_DIR}.zip" "$OUTPUTS_DIR"/

      - name: Upload to GitHub Artifacts
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUTS_DIR }}.zip
          path: ${{ env.OUTPUTS_DIR }}.zip
          retention-days: ${{ github.event.inputs.retention_days }}

      - name: Commit outputs to repository
        if: steps.check_outputs.outputs.folder_not_empty == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUTS_DIR"
          if ! git diff --cached --quiet; then
            git commit -m "Sync $OUTPUTS_DIR from workflow run ${{ github.run_id }}"
            git push
          else
            echo "No changes to commit"
          fi
